<?xml version="1.0" encoding="UTF-8"?>
<!--============================================================================================-->
<!--Delegating build script, used by cruisecontrol to build MY_PROJECT_1.-->
<!--Note that the basedir is set to the checked out project-->
<!--============================================================================================-->
<project name="build-faktorips" basedir="checkout/../">
    <!-- global properties -->
	<property name="cvsroot" value=":local:/usr/local/cvsroot"/>
    
	<!--needs to be updated on every buildcall IMPORTANT - DONT TOUCH THIS!!!!-->
    <target name="updateBuildTemplate">
        <property name="cvsBuildmodule" value="org.faktorips.build"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsBuildmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
    </target>
    
	<!--============================================================================================-->
    <!--project targets. please note: each new target has to be a dependant of "updateBuildTemplate"-->
    <!--============================================================================================-->
	
    <target name="util" depends="updateBuildTemplate" description="builds the 'org.faktorips.util' project">
        <property name="cvsUtilmodule" value="org.faktorips.util"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsUtilmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsUtilmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsUtilmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="valuetypes" depends="updateBuildTemplate" description="builds the 'org.faktorips.valuetypes' project" unless="isMinVersion3">
        <property name="cvsValuetypesmodule" value="org.faktorips.valuetypes"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsValuetypesmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsValuetypesmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsValuetypesmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="valuetypes.java5" depends="updateBuildTemplate" description="builds the 'org.faktorips.valuetypes.java5' project">
        <property name="cvsValuetypesmodule" value="org.faktorips.valuetypes.java5"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsValuetypesmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsValuetypesmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsValuetypesmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="dtflcommon" depends="updateBuildTemplate" description="builds the 'org.faktorips.dtflcommon' project">
        <property name="cvsDtflcommonmodule" value="org.faktorips.dtflcommon"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsDtflcommonmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsDtflcommonmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsDtflcommonmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="runtime" depends="updateBuildTemplate" description="builds the 'org.faktorips.runtime' project" unless="isMinVersion3">
        <property name="cvsRuntimemodule" value="org.faktorips.runtime"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsRuntimemodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the clean-target-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="clean"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="runtime.java5" depends="updateBuildTemplate" description="builds the 'org.faktorips.runtime.java5' project">
        <property name="cvsRuntimemodule" value="org.faktorips.runtime.java5"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsRuntimemodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the clean-target-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="clean"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

    <target name="runtime.groovy" depends="updateBuildTemplate" description="builds the 'org.faktorips.runtime.groovy' project" if="isMinVersion3">
        <property name="cvsRuntimemodule" value="org.faktorips.runtime.groovy"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsRuntimemodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the clean-target-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="clean"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

    <target name="runtime.productdataprovider.ejbclient" depends="updateBuildTemplate" description="builds the 'org.faktorips.runtime.productdataprovider.ejbclient' project" if="isMinVersion3">
        <property name="cvsRuntimemodule" value="org.faktorips.runtime.productdataprovider.ejbclient"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsRuntimemodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the clean-target-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="clean"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

    <target name="runtime.productdataservice" depends="updateBuildTemplate" description="builds the 'org.faktorips.runtime.productdataservice' project" if="isMinVersion3">
        <property name="cvsRuntimemodule" value="org.faktorips.runtime.productdataservice"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsRuntimemodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the clean-target-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="clean"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

    <target name="runtime.productdataservice.common" depends="updateBuildTemplate" description="builds the 'org.faktorips.runtime.productdataservice.common' project" if="isMinVersion3">
        <property name="cvsRuntimemodule" value="org.faktorips.runtime.productdataservice.common"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsRuntimemodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the clean-target-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="clean"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

    <target name="fl" depends="updateBuildTemplate" description="builds the 'org.faktorips.fl' project">
        <property name="cvsFlmodule" value="org.faktorips.fl"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsFlmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="cleanParserSource"/>
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
    <target name="devtools.ant" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.ant' project">
        <property name="cvsAntModule" value="org.faktorips.devtools.ant"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsAntModule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsAntModule}/" antfile="scripts/buildExtraJAR.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsAntModule}/" antfile="scripts/buildExtraJAR.xml" target="main"/>
    </target>
	
    <target name="devtools.core" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.core' project">
        <property name="cvsFlmodule" value="org.faktorips.devtools.core"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsFlmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="devtools.core.ui" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.core.ui' project">
        <property name="cvsCoreUimodule" value="org.faktorips.devtools.core.ui"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsCoreUimodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsCoreUimodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsCoreUimodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

    <target name="devtools.core.htmlexport" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.core.htmlexport' project">
        <property name="cvsCoreHtmlexportmodule" value="org.faktorips.devtools.core.htmlexport"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsCoreHtmlexportmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsCoreHtmlexportmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsCoreHtmlexportmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

    <target name="devtools.tableconversion" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.tableconversion' project">
        <property name="cvsModule" value="org.faktorips.devtools.tableconversion"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsModule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="nebula" depends="updateBuildTemplate" description="builds the 'org.faktorips.nebula' project">
        <property name="cvsModule" value="org.faktorips.nebula"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsModule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
        	
    <target name="devtools.stdbuilder" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.stdbuilder' project">
        <property name="cvsFlmodule" value="org.faktorips.devtools.stdbuilder"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsFlmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

	<target name="uml" depends="updateBuildTemplate" description="builds the 'org.faktorips.uml' project">
        <property name="cvsModule" value="org.faktorips.uml"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsModule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

	<target name="ormext" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.ormext' project">
    	<property name="checkoutdir" value="checkout"/>
    	<property name="cvsTag" value="HEAD"/>
        <property name="buildDir" value="${basedir}/${checkoutdir}"/>

        <property name="cvsModule" value="org.faktorips.devtools.ormext"/>
        <property name="projectDir" value="${checkoutdir}"/>
        <!--checkout/update project-->
		<antcall target="-checkout.all" />
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

	<target name="ormext.ui" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.ormext.ui' project">
    	<property name="checkoutdir" value="checkout"/>
    	<property name="cvsTag" value="HEAD"/>
        <property name="buildDir" value="${basedir}/${checkoutdir}"/>

        <property name="cvsModule" value="org.faktorips.devtools.ormext.ui"/>
        <property name="projectDir" value="${checkoutdir}"/>
        <!--checkout/update project-->
		<antcall target="-checkout.all" />
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

    <!--============================================================================================-->
    <!--project targets for additional customers plugins, e.g. BBV, KQV-->
    <!--============================================================================================-->
    
    <target name="de.qv.faktorips" depends="updateBuildTemplate" description="builds the 'de.qv.faktorips' project">
        <property name="cvsModule" value="de.qv.faktorips"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="${cvsModule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsModule}/build/" antfile="build.xml" target="buildjar"/>
    </target>

	<target name="de.bbv.faktorips.runtime" depends="updateBuildTemplate" description="builds the 'de.bbv.faktorips.runtime' project">
        <property name="cvsFlmodule" value="de.bbv.faktorips.runtime"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="de.bbv.cm.CMPlugin" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co" package="${cvsFlmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
		
    <target name="de.bbv.faktorips.devtools" depends="updateBuildTemplate" description="builds the 'de.bbv.faktorips.devtools' project">
        <property name="cvsFlmodule" value="de.bbv.faktorips.devtools"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co" package="de.bbv.cm.CMPlugin" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co" package="${cvsFlmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
	
    <target name="devtools.msgpm" depends="updateBuildTemplate" description="builds the  project">
        <property name="cvsFlmodule" value="org.faktorips.devtools.msgpm"/>
        <property name="buildDir" value="checkout/"/>
        <!--checkout/update project-->
        <delete includeemptydirs="true" dir="${cvsFlmodule}"/>
        <cvs command="co" package="${cvsFlmodule}" dest="${buildDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${buildDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <!--============================================================================================-->
    <!--targets using the pluginbuilder,-->
    <!--build and test the faktorips feature and runs the integration test-->
    <!--============================================================================================-->
    
	<!--this target build the faktorips features and runs the plugin tests-->
    <target name="pluginbuilder.faktorips" description="builds the complete faktorips feature and executes all junit plugin test">
    	<property name="label" value="0"/> <!-- e.g. build nr given from cruise control -->
    	<property name="checkoutdir" value="checkout"/>
    	<property name="cvsTag" value="HEAD"/>
    	<property name="cvsPluginbuildermodule" value="org.faktorips.pluginbuilder"/>
    	<property name="pluginbuildermodule" value="${cvsPluginbuildermodule}"/>
        <property name="projectsRootDir" value="${basedir}/${checkoutdir}"/>
        <property name="pluginbuilderTmpDir" value="pluginbuilder_tmp"/>
    	<property name="buildDirectory" value="${basedir}/${pluginbuilderTmpDir}/${pluginbuildermodule}"/>
    	<property name="pluginbuilder.config" value="${projectsRootDir}/${pluginbuildermodule}/pluginbuilder.config"/>

    	<cvs command="co" package="${cvsPluginbuildermodule}" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
    	<antcall target="-checkout.all" />
    	
    	<antcall inheritall="true" target="-delete.eclipse.configuration.log"/>
    	
    	<!-- if only the creating of the plugin and features should be tested, runtests=false -->
        <condition property="isIgnoreTests" value="true">
             <equals arg1="${runtests}" arg2="false"/>
         </condition>
        <antcall inheritall="true" target="-disable.automated.test" />
        <antcall inheritall="true" target="-enable.automated.test" />

        <!-- delegate to the pluginbuilder target -->
    	<ant dir="${projectsRootDir}/${pluginbuildermodule}/" antfile="build.xml" target="main-cc">
            <property name="label" value="${label}"/>
            <property name="buildDirectory" value="${buildDirectory}"/>
        </ant>
    </target>
    
	<!-- target to copy cc build artefacts -->
	<target name="copy.artifacts.pluginbuilder.faktorips" description="target to copy cc build artefacts">
		<!-- properties from cc: ccProjectDir (defined in config.xml), 
		                         cctimestamp (see cc reference), 
		                         thisbuildsuccessful (see cc reference),
		                         workspaceName (constant in config.xml) -->
		<property name="pluginbuilderTmpDir" value="pluginbuilder_tmp"/>
		<property name="buildDirectory" value="${basedir}/${pluginbuilderTmpDir}/org.faktorips.pluginbuilder"/>
		
		<defaultexcludes remove="**/._*"/>
		
	    <condition property="is.thisbuildsuccessful" value="true">
	        <equals arg1="${thisbuildsuccessful}" arg2="true"/>
	    </condition>
	    <condition property="is.plugintest" value="true">
	        <equals arg1="${workspaceName}" arg2="workspace"/>
	    </condition>
		
		<!-- create the cc artifact directory for the current build -->
		<mkdir dir="${ccProjectDir}/${cctimestamp}"/>

		<!-- copy eclipse workspace logfile -->
		<!-- problems if the workspace has been created, but there is an error or exception in the workspace -->
        <antcall inheritall="true" target="-copy.eclipse.workspace.log"/> <!-- if build fails, and this is the plugin or integrationtest workspace -->
        <antcall inheritall="true" target="-copy.eclipse.test.workspace.log"/> <!-- if build fails and this is the plugin workspace -->
		
		<!-- copy eclipse configuration log -->
		<!-- problems if the workspace hasn't been created in case of errors, e.g. feature not found -->
        <antcall inheritall="true" target="-copy.eclipse.configuration.log"/>

		<!-- copy automated test html report -->
		<copy file="${buildDirectory}/results/testresults/html/testReport_N-${label}.html" 
			todir="${ccProjectDir}/${cctimestamp}"
			failonerror="false" verbose="true"/>

		<!-- copy emma coverage report if available -->
        <copy todir="${ccProjectDir}/${cctimestamp}" failonerror="false" verbose="true">
            <fileset dir="${buildDirectory}/results/testresults/coverage" includes="**/*"/>
        </copy>
		
		<!-- copy plugin compile errors -->
		<antcall inheritall="true" target="-copy.pluginbuilder.compile.error"/>
		
		<!-- copy java output, eclipse output from org.eclipse.equinox.launcher.Main --> 
		<antcall inheritall="true" target="-copy.javaoutput"/>
		
	</target>
	
    <!--this target runs the integrationtest, 
       the target org.faktorips.pluginbuilder must be executed before, this will be handled by cruisecontrol-->
    <target name="pluginbuilder.integrationtest" description="target to run the faktorips integrationtest, using the previous build faktorips feature">
        <property name="pluginbuilderTmpDir" value="pluginbuilder_tmp"/>
        <property name="buildDirectory" value="${basedir}/${pluginbuilderTmpDir}/org.faktorips.pluginbuilder"/>
    	<property name="checkoutdir" value="checkout"/>
    	<property name="cvsTag" value="HEAD"/>
        <property name="projectsRootDir" value="${basedir}/${checkoutdir}"/>
    	<property name="cvsIntegrationtestmodule" value="org.faktorips.integrationtest"/>
        <property name="projectIntegrationtestDir" value="${checkoutdir}"/>
        <property name="isUseCvs" value="true"/>
    	
    	<!--checkout org.faktorips.integrationtest project-->
        <cvs command="co" package="${cvsIntegrationtestmodule}" dest="${projectIntegrationtestDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
        
    	<!-- checkout faktorips build project because of importProject.xml script -->
    	<antcall inheritall="true" target="-checkout.build"/>
    	
    	<antcall inheritall="true" target="-delete.eclipse.configuration.log"/>
        
    	<!--delegate to the pluginbuilder integrationtest target-->
        <ant dir="${projectsRootDir}/org.faktorips.pluginbuilder/" antfile="build.xml" target="integrationtest">
        	<property name="buildDirectory" value="${buildDirectory}"/>        	
        </ant>	
    </target>

	<!--this target runs the integrationtest for java5, 
       the target org.faktorips.pluginbuilder must be executed before, this will be handled by cruisecontrol-->
    <target name="pluginbuilder.integrationtest.java5" description="target to run the faktorips integrationtest for java5, using the previous build faktorips feature">
        <property name="pluginbuilderTmpDir" value="pluginbuilder_tmp"/>
        <property name="buildDirectory" value="${basedir}/${pluginbuilderTmpDir}/org.faktorips.pluginbuilder"/>
        <property name="checkoutdir" value="checkout"/>
        <property name="cvsTag" value="HEAD"/>
    	<property name="projectsRootDir" value="${basedir}/${checkoutdir}"/>
        <property name="cvsIntegrationtestmodule" value="org.faktorips.integrationtest.java5"/>
        <property name="projectIntegrationtestDir" value="${checkoutdir}"/>
    	<property name="isUseCvs" value="true"/>
        
    	<!--checkout org.faktorips.integrationtest project-->
        <cvs command="co" package="${cvsIntegrationtestmodule}" dest="${projectIntegrationtestDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
        
    	<!-- checkout faktorips build project because of importProject.xml script -->
        <antcall inheritall="true" target="-checkout.build"/>
    	
    	<antcall inheritall="true" target="-delete.eclipse.configuration.log"/>
        
    	<!--delegate to the pluginbuilder integrationtest target-->
        <ant dir="${projectsRootDir}/org.faktorips.pluginbuilder/" antfile="build.xml" target="integrationtest.java5">
        	<property name="buildDirectory" value="${buildDirectory}"/>        	
        </ant>
    </target>
	
    <!--this target builds the faktorips release madatory parameter: 
           -Dbuild.version -> the version which will be released
           -Dbuild.category -> the version of the category in the updatesite site.xml file -->
    <!--optional parameters:
           -Doverwrite=true -> to overwrite previous build version or throw a build fail if version exists
           -Druntests=false -> run or ignore junit plugin tests 
           -DskipPublish=true -> don't publish the result to the download and updatesite
        optional parameter for a local build:   
           -DnoCvs=true -> no cvs support (the features and plugins will be copied from the workspace
           -DnoBranch=false -> branch support, in this case the all_cvs_branch.map must exists in the map 
                               directory (see all_cvs.map with BRANCHLABEL instead of HEAD inside)
           -DproductProject -> build the given product instead of features and plugins
                             the given value must be the project name where the FaktorIps.product exists
                             e.g. org.faktorips.devtools.core or de.qv.faktorips
           -DprojectsRootDir -> the root dir of all plugin projects
           -Dbasedir -> e.g. the parent dir of the dir specified in projectsRootDir, this will be the working dir
         additionaly make sure that the build_host_<hostname>.properies exists in the pluginbuilder project-->
    <!-- Note: to tag and to creating the release.properties, please use the releaseFaktorIps.sh script 
               the releaseFaktorIps.sh script uses implicit this ant target -->
	<!-- Example local release build:
	   ant -buildfile [workspace]\org.faktorips.build\cruisecontrol_config\build-faktorips.xml 
	       -Dbuild.version=2.2.0.rc1 -Dbuild.category=2.2 -Doverwrite=true -Druntests=false -DskipPublish=true 
	       -DnoCvs=true -DprojectsRootDir=[workspace] -Dbasedir=[workspace]\.. release
	-->
	<target name="release" 
    	description="release build for an specified faktorips release version, builds the complete feature, executes the junit plugin tests and distributes the result to the update site and download directory">
        <!-- defauls properties -->
    	<property name="noCvs" value="false"/>
    	<property name="publishResult" value="false"/>
    	<!-- directories on server -->
        <property name="projectsRootDir" value="${basedir}/checkout_release/"/>
    	<property name="updatesite.path" value="/var/www/update.faktorzehn.org/faktorips/org.faktorips.updatesite"/>
    	<property name="downloadDir" value="/var/www/localhost/htdocs/update.faktorzehn.org/faktorips/downloads"/>
    	<property name="buildDirectory" value="${basedir}/pluginbuilder_release_tmp/org.faktorips.pluginbuilder_release"/>
        <!-- download zip file names -->
        <!--   core -->
		<property name="faktoripsReleaseDownloadZipPath" value="${downloadDir}/faktorips-${build.version}.zip"/>
        <property name="faktoripsNls1ReleaseDownloadZipPath" value="${downloadDir}/faktorips-nls1-${build.version}.zip"/>
        <!--   uml -->
		<property name="faktoripsUmlReleaseDownloadZipPath" value="${downloadDir}/faktorips-uml-${build.version}.zip"/>
        <property name="faktoripsUmlNls1ReleaseDownloadZipPath" value="${downloadDir}/faktorips-uml-nls1-${build.version}.zip"/>
        <!--   ormext -->
		<property name="faktoripsOrmextReleaseDownloadZipPath" value="${downloadDir}/faktorips-ormext-${build.version}.zip"/>
        <property name="faktoripsOrmextNls1ReleaseDownloadZipPath" value="${downloadDir}/faktorips-ormext-nls1-${build.version}.zip"/>
        <!--   updatesite -->
        <property name="faktoripsUpdateSiteZipPath" value="${downloadDir}/faktorips-updateSite-${build.version}.zip"/>
        <!--    product zip -->
		<property name="faktoripsProductWinZipPath" value="${downloadDir}/faktorips-win32.x86-${productProject}-${build.version}.zip"/>
        <property name="faktoripsProductLinuxZipPath" value="${downloadDir}/faktorips-linux.gtk.x86-${productProject}-${build.version}.zip"/>
        <!--    runtime and valuetypes zip -->
		<property name="faktoripsRuntimeAndValuetypesZipName" value="faktorips-runtime-valuetypes-${build.version}.zip"/>
		<property name="faktoripsRuntimeAndValuetypesZipPath" value="${downloadDir}/${faktoripsRuntimeAndValuetypesZipName}"/>
        <!--    runtime addons zip -->
		<property name="faktoripsRuntimeAddonsZipName" value="faktorips-runtime-addons-${build.version}.zip"/>
		<property name="faktoripsRuntimeAddonsZipPath" value="${downloadDir}/${faktoripsRuntimeAddonsZipName}"/>
    	<!-- pluginbuilder configuration files -->
    	<property name="release.properties" value="${projectsRootDir}/org.faktorips.pluginbuilder/releases/${build.version}.properties"/>
        <property name="pluginbuilder.config" value="${projectsRootDir}/org.faktorips.pluginbuilder/pluginbuilder.config"/>
    	<!-- features to integrate in site.xml -->
    	<property name="pluginbuilder.features" value="org.faktorips.feature,org.faktorips.feature.nls1,org.faktorips.feature.source"/>
    	<property name="pluginbuilder.features.uml" value="org.faktorips.uml.feature,org.faktorips.uml.feature.nls1,org.faktorips.uml.feature.source"/>
    	<property name="pluginbuilder.features.ormext" value="org.faktorips.ormext.feature,org.faktorips.ormext.feature.nls1,org.faktorips.ormext.feature.source"/>


		<condition property="isMinVersion3" value="true" >
			<not>
				<!-- by checking NOT FALSE we get isMinVersion3=true if minVersion3 is not set -->
	        	<equals arg1="${minVersion3}" arg2="false"/>
			</not>
		</condition>
		<condition property="isNotVersion3" value="true">
			<not>
		        <equals arg1="${minVersion3}" arg2="true"/>
			</not>
		</condition>
		
      <condition property="isUseCvs" value="true">
        <equals arg1="${noCvs}" arg2="false"/>
      </condition>

      <condition property="isUseBranch" value="true">
        <equals arg1="${noBranch}" arg2="false"/>
      </condition>

    	<condition property="isIgnoreTests" value="true">
            <equals arg1="${runtests}" arg2="false"/>
        </condition>
		
	    <condition property="isSkipPublish" value="true">
	    	 <equals arg1="${skipPublish}" arg2="true"/>
	    </condition>

      <condition property="is.product.build" value="true">
         <length string="${productProject}" when="greater" length="0" />
	    </condition>

      <!-- check if the copy all.map should be used, if useCvs is false 
		     otherwise the cvs all.map is used to fetch the sources from cvs -->
      <condition property="all.map" value="all_copy.map">
         <not><equals arg1="${isUseCvs}" arg2="true"/></not>
      </condition>
    	<!-- check if the branch all.map should be used, if a branch is given 
    		     otherwise the cvs all.map is used to fetch the sources from cvs -->
	    <condition property="all.map" value="all_cvs_branch.map">
         <isset property="${isUseBranch}"/>
      </condition>
    	<!-- special case if an other cvs root is used, e.g. skript testing  -->
	  <condition property="all.map" value="all_cvs_different_cvsroot.map">
         <available file="${projectsRootDir}/org.faktorips.pluginbuilder/maps/all_cvs_different_cvsroot.map"/>
      </condition>
		
    	<!--checkout pluginbuilder, build project -->
    	<antcall inheritall="true" target="-checkout.pluginbuilder"/>
    	<antcall inheritall="true" target="-checkout.build"/>
    	
    	<!--asserts-->
        <!--1. check if the build.version property is given-->
        <fail unless="build.version" message="Please specify the build.version, e.g. ant ... -Dbuild.version=2.2.0.rfinal"/>
        <fail unless="build.category" message="Please specify the build.category, e.g. ant ... -Dbuild.category=2.2"/>
    	<!--2. check if the build.verion property file exists-->
        <available type="file" file="${release.properties}" property="releasePropertiesExists"/>
        <fail message="Could not find ${build.version}.properties in ${projectsRootDir}/org.faktorips.pluginbuilder/releases/" unless="releasePropertiesExists"/>
    	<!--3. check previous release build with same target, check file exists in download dir -->
    	<antcall inheritall="true" target="-assert.release.exists">
		</antcall>
    	<antcall inheritall="true" target="-assert.product.exists">
		</antcall>

    	<!-- checkout pluginbuilder with correct build.version -->
    	<antcall inheritall="true" target="-checkout.pluginbuilder.build.version"/>
    	<!-- patch run test property -->
    	<antcall inheritall="true" target="-disable.automated.test" />
    	<antcall inheritall="true" target="-enable.automated.test" />
    	
        <!--checkout updatesite-->
    	<antcall inheritall="true" target="-checkout.updatesite"/>
        
        <!--build release unsing pluginbuilder main target-->
		<ant dir="${projectsRootDir}/org.faktorips.pluginbuilder/" antfile="build.xml" target="main">
            <property name="build.version" value="${build.version}"/>
            <property name="buildDirectory" value="${buildDirectory}"/>
            <property name="pluginbuilder.is.rcpbuild" value="${is.product.build}"/>
            <property name="product.project" value="${productProject}"/>
            <property name="updateSiteCategoryName" value="Faktor-IPS ${build.category}"/>
            <property name="updateSiteCategoryLabel" value="Faktor-IPS ${build.category}"/>
            <property name="updateSiteDescription" value="FaktorIPS update site"/>
            <property name="updateSiteUrl" value="http://update.faktorzehn.org/faktorips"/>    		
        </ant>
		
	    <!-- build runtime and valuetypes separately,
		       the eclipse build doesn't set the version number in the manifest file -->
		<antcall inheritall="true" target="-buildAndPublish.release.runtimeAndValuetypesJars"/>
		<antcall inheritall="true" target="-buildAndPublish.release.runtimeAddons"/>

		<antcall inheritall="true" target="-publish.release.all"/>
		<antcall inheritall="true" target="-publish.product"/>
		
		<!-- store archiv results, to add the license file later -->
		<echo file="${basedir}/archives_features">
${faktoripsReleaseDownloadZipPath}
${faktoripsNls1ReleaseDownloadZipPath}
${faktoripsUmlReleaseDownloadZipPath}
${faktoripsUmlNls1ReleaseDownloadZipPath}
${faktoripsOrmextReleaseDownloadZipPath}
${faktoripsOrmextNls1ReleaseDownloadZipPath}
${faktoripsUpdateSiteZipPath}
${faktoripsRuntimeAndValuetypesZipPath}
${faktoripsRuntimeAddonsZipPath}
		</echo>
		<echo file="${basedir}/archives_products">
${faktoripsProductWinZipPath}
${faktoripsProductLinuxZipPath}
		</echo>
	</target>
	
    <!--helper targets-->
    <target name="-buildAndPublish.release.runtimeAndValuetypesJars" unless="is.product.build">
    	<antcall target="-buildAndPublish.release.OLD_runtimeAndValuetypesJars" />
    	<ant dir="${buildDirectory}/plugins/org.faktorips.valuetypes.java5/build" antfile="build.xml" target="buildAllsJars">
    	    <property name="buildproject.path" value="${projectsRootDir}/org.faktorips.build"/>
    	</ant>
        <ant dir="${buildDirectory}/plugins/org.faktorips.runtime.java5/build" antfile="build.xml" target="buildAllsJars">
    	    <property name="buildproject.path" value="${projectsRootDir}/org.faktorips.build"/>
    	</ant>
        <antcall inheritall="true" target="-publish.release.runtimeAndValutypesJars"></antcall>
    </target>
	
	<target name="-buildAndPublish.release.OLD_runtimeAndValuetypesJars" unless="isMinVersion3">
    	<!-- build runtime and valutypes using own build files -->
    	<ant dir="${buildDirectory}/plugins/org.faktorips.valuetypes/build" antfile="build.xml" target="buildAllsJars">
    	    <property name="buildproject.path" value="${projectsRootDir}/org.faktorips.build"/>
    	</ant>
        <ant dir="${buildDirectory}/plugins/org.faktorips.runtime/build" antfile="build.xml" target="buildAllsJars">
    	    <property name="buildproject.path" value="${projectsRootDir}/org.faktorips.build"/>
    	</ant>
	</target>
	
	<target name="-publish.release.runtimeAndValutypesJars">
       <property name="zip.dir" value="${buildDirectory}/zip_tmp"/>
       <property name="zipFile" value="${buildDirectory}/results/${faktoripsRuntimeAndValuetypesZipName}"/>
       <echo message="Create runtime and valuetypes zip file: ${zipFile}"/> 
	   <delete includeemptydirs="true" dir="${zip.dir}"/>
       <mkdir dir="${zip.dir}"/>
	   <copy todir="${zip.dir}" failonerror="${isNotVersion3}">
	   	<fileset dir="${buildDirectory}/plugins/org.faktorips.valuetypes/build/results" includes="*.jar *.zip" />
	   	<fileset dir="${buildDirectory}/plugins/org.faktorips.runtime/build/results" includes="*.jar *.zip"/>
	   </copy>
      <copy todir="${zip.dir}">
		   	<fileset dir="${buildDirectory}/plugins/org.faktorips.valuetypes.java5/build/results" includes="*.jar *.zip"/>
		   	<fileset dir="${buildDirectory}/plugins/org.faktorips.runtime.java5/build/results" includes="*.jar *.zip"/>
	   </copy>
       <zip destfile="${zipFile}" basedir="${zip.dir}" />
       <antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
           <param name="source" value="${faktoripsRuntimeAndValuetypesZipName}" />
           <param name="dest.name" value="${faktoripsRuntimeAndValuetypesZipPath}" />
       </antcall>
    </target>
	
    <target name="-buildAndPublish.release.runtimeAddons" unless="is.product.build" if="isMinVersion3">
    	<!-- checkout and build runtime addons. these project are not handled as plugins and so not checked out via pluginbuilder -->
    	<property name="buildDir" value="${buildDirectory}/plugins"/>
    	<antcall target="runtime.groovy" />
    	<antcall target="runtime.productdataservice.common" />
    	<antcall target="runtime.productdataservice"/>
       	<antcall target="runtime.productdataprovider.ejbclient"/>
    	
        <antcall inheritall="true" target="-publish.release.runtimeAddons"></antcall>
    </target>
	<target name="-publish.release.runtimeAddons">
       <property name="zip.dir" value="${buildDirectory}/zip_tmp"/>
       <property name="zipFile" value="${buildDirectory}/results/${faktoripsRuntimeAddonsZipName}"/>
       <echo message="Create runtime addons zip file: ${zipFile}"/> 
	   <delete includeemptydirs="true" dir="${zip.dir}"/>
       <mkdir dir="${zip.dir}"/>
	   <copy todir="${zip.dir}">
	   	<fileset dir="${buildDirectory}/plugins/org.faktorips.runtime.groovy/build/results" includes="*.jar *.zip"/>
	   	<fileset dir="${buildDirectory}/plugins/org.faktorips.runtime.productdataservice.common/build/results" includes="*.jar *.zip"/>
	   	<fileset dir="${buildDirectory}/plugins/org.faktorips.runtime.productdataservice/build/results" includes="*.jar *.zip"/>
	   	<fileset dir="${buildDirectory}/plugins/org.faktorips.runtime.productdataprovider.ejbclient/build/results" includes="*.jar *.zip"/>
	   </copy>
       <zip destfile="${zipFile}" basedir="${zip.dir}" />
       <antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
           <param name="source" value="${faktoripsRuntimeAddonsZipName}" />
           <param name="dest.name" value="${faktoripsRuntimeAddonsZipPath}" />
       </antcall>
    </target>

	
	
	
	<target name="-assert.product.exists" if="is.product.build">
        <antcall inheritall="true" target="-fail.if.file.exists">
             <param name="file" value="${faktoripsProductLinuxZipPath}"/>
        </antcall>
        <antcall inheritall="true" target="-fail.if.file.exists">
             <param name="file" value="${faktoripsProductWinZipPath}"/>
        </antcall>
	</target>
	<target name="-assert.release.exists" unless="is.product.build">
        <antcall inheritall="true" target="-fail.if.file.exists">
             <param name="file" value="${faktoripsReleaseDownloadZipPath}"/>
         </antcall>
         <antcall inheritall="true" target="-fail.if.file.exists">
             <param name="file" value="${faktoripsNls1ReleaseDownloadZipPath}"/>
         </antcall>
         <antcall inheritall="true" target="-fail.if.file.exists">
             <param name="file" value="${faktoripsUmlReleaseDownloadZipPath}"/>
         </antcall>
         <antcall inheritall="true" target="-fail.if.file.exists">
             <param name="file" value="${faktoripsUmlNls1ReleaseDownloadZipPath}"/>
         </antcall>
         <antcall inheritall="true" target="-fail.if.file.exists">
             <param name="file" value="${faktoripsOrmextReleaseDownloadZipPath}"/>
         </antcall>
         <antcall inheritall="true" target="-fail.if.file.exists">
             <param name="file" value="${faktoripsOrmextNls1ReleaseDownloadZipPath}"/>
         </antcall>
         <antcall inheritall="true" target="-fail.if.file.exists">
             <param name="file" value="${faktoripsUpdateSiteZipPath}"/>
         </antcall>
	</target>
	<target name="-publish.product" if="is.product.build">
		<antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
             <param name="source" value="faktorips-${build.version}-linux.gtk.x86.zip" />
             <param name="dest.name" value="${faktoripsProductLinuxZipPath}" />
        </antcall>
		<antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
             <param name="source" value="faktorips-${build.version}-win32.win32.x86.zip" />
             <param name="dest.name" value="${faktoripsProductWinZipPath}" />
        </antcall>
        <echo message="finished. Product build: ${productProject}"/>
		<antcall inheritall="true" target="-publish.product.info"/>
	</target>
	<target name="-publish.product.info" unless="isSkipPublish">
        <echo message="   1. ${faktoripsProductLinuxZipPath}"/>		
        <echo message="   2. ${faktoripsProductWinZipPath}"/>		
	</target>
	<target name="-publish.release.all" unless="is.product.build">
		<antcall inheritall="true" target="-publish.release.all.internal"/>
	</target>
	<target name="-publish.release.all.internal" unless="isSkipPublish">
        <!--copy zipped features into the faktorips download directory -->
        <!-- faktorips -->
        <mkdir dir="${downloadDir}" />
        <antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
            <param name="source" value="org.faktorips.feature-${build.version}.zip" />
            <param name="dest.name" value="${faktoripsReleaseDownloadZipPath}" />
        </antcall>
        <antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
            <param name="source" value="org.faktorips.feature.nls1-${build.version}.zip" />
            <param name="dest.name" value="${faktoripsNls1ReleaseDownloadZipPath}" />
        </antcall>
        <!-- uml -->
        <antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
            <param name="source" value="org.faktorips.uml.feature-${build.version}.zip" />
            <param name="dest.name" value="${faktoripsUmlReleaseDownloadZipPath}" />
        </antcall>
        <antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
            <param name="source" value="org.faktorips.uml.feature.nls1-${build.version}.zip" />
            <param name="dest.name" value="${faktoripsUmlNls1ReleaseDownloadZipPath}" />
        </antcall>
        <!-- ormext -->
        <antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
            <param name="source" value="org.faktorips.ormext.feature-${build.version}.zip" />
            <param name="dest.name" value="${faktoripsOrmextReleaseDownloadZipPath}" />
        </antcall>
        <antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
            <param name="source" value="org.faktorips.ormext.feature.nls1-${build.version}.zip" />
            <param name="dest.name" value="${faktoripsOrmextNls1ReleaseDownloadZipPath}" />
        </antcall>
        <!-- updatesite -->
        <antcall inheritall="true" target="-copy.faktorips.release.to.download.dir">
            <param name="source" value="updateSite-${build.version}.zip" />
            <param name="dest.name" value="${faktoripsUpdateSiteZipPath}" />
        </antcall>
        
        <!--install the features on updatesite-->
        <!--  generate a new site.xml on the updatesite, including all previous and new feature versions-->
        <!--  faktorips features -->
        <ant dir="${projectsRootDir}/org.faktorips.pluginbuilder/build-files" antfile="postBuild.xml" target="-createNightlyBuildSiteXml">
            <property name="siteXmlFile" value="${projectsRootDir}/org.faktorips.updatesite/site_tmp.xml"/>
            <property name="pluginbuilder.features" value="${pluginbuilder.features}"/>
            <property name="buildDirectory" value="${buildDirectory}"/>
            <property name="buildHome" value="${projectsRootDir}/org.faktorips.pluginbuilder"/>
            <property name="updateSiteCategoryName" value="Faktor-IPS ${build.category}"/>
            <property name="updateSiteCategoryLabel" value="Faktor-IPS ${build.category}"/>
            <property name="updateSiteDescription" value="FaktorIPS update site"/>
            <property name="updateSiteUrl" value="http://update.faktorzehn.org/faktorips"/>
        </ant>
        <!--  merge the generated site.xml with the previous site.xml as new site.xml-->
        <antcall inheritall="true" target="-merge.updatesite.xml">
            <param name="site.xml" value="site_tmp.xml"/> 
        </antcall> 
    
        <!--  uml features -->
        <ant dir="${projectsRootDir}/org.faktorips.pluginbuilder/build-files" antfile="postBuild.xml" target="-createNightlyBuildSiteXml">
            <property name="siteXmlFile" value="${projectsRootDir}/org.faktorips.updatesite/site_uml_tmp.xml"/>
            <property name="pluginbuilder.features" value="${pluginbuilder.features.uml}"/>
            <property name="buildDirectory" value="${buildDirectory}"/>
            <property name="buildHome" value="${projectsRootDir}/org.faktorips.pluginbuilder"/>
            <property name="updateSiteCategoryName" value="Faktor-IPS ${build.category}"/>
            <property name="updateSiteCategoryLabel" value="Faktor-IPS ${build.category}"/>
            <property name="updateSiteDescription" value="FaktorIPS update site"/>
            <property name="updateSiteUrl" value="http://update.faktorzehn.org/faktorips"/>
        </ant>
        <!--  merge the generated site.xml with the previous site.xml as new site.xml-->
        <antcall inheritall="true" target="-merge.updatesite.xml">
            <param name="site.xml" value="site_uml_tmp.xml"/> 
        </antcall> 
		
        <!--  ormext features -->
		<!-- TODO ormext auf die updatesite bringen (nach freigabe)
        <ant dir="${projectsRootDir}/org.faktorips.pluginbuilder/build-files" antfile="postBuild.xml" target="-createNightlyBuildSiteXml">
            <property name="siteXmlFile" value="${projectsRootDir}/org.faktorips.updatesite/site_ormext_tmp.xml"/>
            <property name="pluginbuilder.features" value="${pluginbuilder.features.ormext}"/>
            <property name="buildDirectory" value="${buildDirectory}"/>
            <property name="buildHome" value="${projectsRootDir}/org.faktorips.pluginbuilder"/>
            <property name="updateSiteCategoryName" value="Faktor-IPS ${build.category}"/>
            <property name="updateSiteCategoryLabel" value="Faktor-IPS ${build.category}"/>
            <property name="updateSiteDescription" value="FaktorIPS update site"/>
            <property name="updateSiteUrl" value="http://update.faktorzehn.org/faktorips"/>
        </ant>
        -->
        <!--  merge the generated site.xml with the previous site.xml as new site.xml-->
        <!-- TODO ormext auf die updatesite bringen (nach freigabe)
		<antcall inheritall="true" target="-merge.updatesite.xml">
            <param name="site.xml" value="site_ormext_tmp.xml"/> 
        </antcall> 
    	-->
        <!--  checkin updatesite, only site.xml will be commited, features and plugin jars are not added to cvs-->
        <antcall inheritall="true" target="-checkin.updatesite"/>
        
        <!--  checkout site.xml -->
        <!--   copy to faktorips updatesite website directory -->
        <antcall inheritall="true" target="-checkout.updatesite.on.faktorips.org"/>
        <antcall inheritall="true" target="-copy.updatesite.to.faktorips.org"/>
        
        <!-- report -->
        <echo message=""/>
        <echo message="result directory: ${buildDirectory}/results/"/>
        <echo message=""/>
        <echo message="finished. Release: ${build.version}"/>
        <echo message="-> new faktorips ips features: ${pluginbuilder.features}"/>
        <echo message="-> new faktorips uml features: ${pluginbuilder.features.uml}"/>
        <echo message="-> new faktorips ormext features: ${pluginbuilder.features.ormext}"/>
        <antcall inheritall="true" target="-print.publish.info"/>    	
    </target>
	<target name="-print.publish.info" unless="isSkipPublish">
        <echo message="-> updatesite: ${updatesite.path}"/>
        <echo message="-> download zip files: "/>
        <echo message="   1. ${faktoripsReleaseDownloadZipPath}"/>
        <echo message="   2. ${faktoripsNls1ReleaseDownloadZipPath}"/>
        <echo message="   3. ${faktoripsUmlReleaseDownloadZipPath}"/>
        <echo message="   4. ${faktoripsUmlNls1ReleaseDownloadZipPath}"/>    	
        <echo message="   5. ${faktoripsOrmextReleaseDownloadZipPath}"/>
        <echo message="   6. ${faktoripsOrmextNls1ReleaseDownloadZipPath}"/>    	
        <echo message="   7. ${faktoripsUpdateSiteZipPath}"/>	
        <echo message="   8. ${faktoripsRuntimeAndValuetypesZipPath}"/>    	
        <echo message="   8. ${faktoripsRuntimeAddonsZipPath}"/>    	
    </target>
	
	<target name="-checkout.all" >
		<!-- checkout features -->
		<cvs command="co" package="org.faktorips.feature" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.feature.nls1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.feature.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	
		<!-- checkout plugins -->
		<cvs command="co" package="org.faktorips.dtflcommon" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.fl" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.util" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.devtools.ant" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.devtools.core" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.devtools.stdbuilder" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.runtime.java5" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.valuetypes.java5" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.devtools.core.ui" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.devtools.tableconversion" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.nebula" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.devtools.core.htmlexport" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		
		<!-- checkout nl1 plugins -->
		<cvs command="co" package="org.faktorips.nls.devtools.core.nl1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.nls.devtools.core.ui.nl1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.devtools.tableconversion.nl1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.nls.devtools.stdbuilder.nl1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.devtools.core.htmlexport.nl1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    
		<!-- checkout test plugins -->
	    <cvs command="co" package="org.faktorips.devtools.core.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.devtools.core.ui.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.devtools.tableconversion.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.devtools.stdbuilder.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.devtools.ant.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.devtools.core.htmlexport.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		
		<!-- checkout faktorips uml plugins and feature -->
	    <cvs command="co" package="org.faktorips.uml.feature" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.uml.feature.nls1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.uml.feature.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.uml" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.uml.nl1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.uml.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		
		<!-- checkout faktorips ormext plugins and feature -->
	    <cvs command="co" package="org.faktorips.ormext.feature" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.ormext.feature.nls1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.ormext.feature.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.devtools.ormext" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.devtools.ormext.hibernate" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.devtools.ormext.ui" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.devtools.ormext.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.nls.devtools.ormext.nl1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	    <cvs command="co" package="org.faktorips.nls.devtools.ormext.ui.nl1" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="de.qv.ormext.builder" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="de.qv.ormext.builder.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>

		<!-- checkout de.qv.faktorips.feature and plugin -->
		<cvs command="co" package="de.qv.faktorips.feature.test" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="de.qv.faktorips.feature" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="de.qv.faktorips.feature.product" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="de.qv.faktorips" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		
		<antcall target="-checkout.OLD_runtimeAndValuetypes" />
		<antcall target="-checkout.runtime.addons" />
    </target>
	
	<target name="-checkout.OLD_runtimeAndValuetypes" unless="isMinVersion3">
		<cvs command="co" package="org.faktorips.runtime" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.valuetypes" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	</target>
	
	<target name="-checkout.runtime.addons" if="isMinVersion3">
		<cvs command="co" package="org.faktorips.runtime.groovy" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.runtime.productdataservice.common" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.runtime.productdataservice" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
		<cvs command="co" package="org.faktorips.runtime.productdataprovider.ejbclient" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${cvsTag}"/>
	</target>
	
    <target name="-checkout.pluginbuilder" if="isUseCvs">
        <cvs command="co" package="org.faktorips.pluginbuilder" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true"/>
    </target>
    <target name="-checkout.pluginbuilder.build.version" if="isUseCvs">
    	<loadproperties srcfile="${release.properties}">
          <filterchain>
            <linecontains>
              <contains value="fetchTag"/>
            </linecontains>
          </filterchain>
    	</loadproperties>
      <delete includeemptydirs="true">
        <fileset dir="${projectsRootDir}/org.faktorips.pluginbuilder" excludes="**/all_cvs_*.map"/>
      </delete>
    	<cvs command="co" package="org.faktorips.pluginbuilder" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true" tag="${fetchTag}"/>
    </target>
    <target name="-checkout.build" if="isUseCvs">
        <cvs command="co" package="org.faktorips.build" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true"/>
    </target>
    <target name="-checkout.updatesite" if="isUseCvs">
        <cvs command="co" package="org.faktorips.updatesite" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true"/>
    </target>
    <target name="-checkin.updatesite" if="isUseCvs" unless="isSkipPublish">
    	<cvs command="commit -m 'release build: ${build.version}'" 
        	package="org.faktorips.updatesite" dest="${projectsRootDir}" cvsroot="${cvsroot}" quiet="true"/>
    </target>
    <target name="-checkout.updatesite.on.faktorips.org" if="isUseCvs" unless="isSkipPublish">
        <echo message="update faktorips.org updatesite: ${updatesite.path}"/>
        <cvs command="co" package="org.faktorips.updatesite" dest="${updatesite.path}" cvsroot="${cvsroot}" quiet="true"/>
    </target>	
    <target name="-copy.faktorips.release.to.download.dir" unless="isSkipPublish">
    	<!-- input: dest.name -->
    	<!--        source    -->
    	<!-- unzip and zip in download dir -->
    	<!-- (if necessary you can add an eclipse folder to the zip file) -->
    	<property name="zip.dir" value="${buildDirectory}/zip_tmp"/>
    	<delete includeemptydirs="true" dir="${zip.dir}"/>

    	<mkdir dir="${zip.dir}"/>
    	<unzip src="${buildDirectory}/results/${source}" dest="${zip.dir}"></unzip>
    	<zip destfile="${dest.name}" basedir="${zip.dir}" />
    </target>
    <target name="-copy.updatesite.to.faktorips.org" unless="isSkipPublish">
        <copy todir="${updatesite.path}/plugins" overwrite="true" verbose="true">
            <fileset dir="${buildDirectory}/updateSite/plugins" includes="*.jar"/>
        </copy>
        <copy todir="${updatesite.path}/features" overwrite="true" verbose="true">
            <fileset dir="${buildDirectory}/updateSite/features" includes="*.jar"/>
        </copy>
    </target>
    <target name="-copy.eclipse.workspace.log">
        <property name="logfile" value="${basedir}/pluginbuilder_tmp/org.faktorips.pluginbuilder/${workspaceName}/.metadata/.log"/>
    <copy file="${logfile}" 
            tofile="${ccProjectDir}/${cctimestamp}/eclipse_workspace.log"
            failonerror="false" verbose="true"/>
    <delete file="${logfile}" failonerror="false" verbose="false"/>
    </target>
    <target name="-copy.eclipse.test.workspace.log" if="is.plugintest" unless="is.thisbuildsuccessful">
    	<property name="logfile" value="${basedir}/pluginbuilder_tmp/org.faktorips.pluginbuilder/test-workspace/.metadata/.log"/>
    	<copy file="${logfile}" 
            tofile="${ccProjectDir}/${cctimestamp}/eclipse_test-workspace.log"
            failonerror="false" verbose="true"/>
    	<delete file="${logfile}" failonerror="false" verbose="false"/>
    </target>
    <target name="-copy.eclipse.configuration.log">
        <copy todir="${ccProjectDir}/${cctimestamp}" failonerror="false" verbose="false">
            <fileset dir="${basedir}/pluginbuilder_tmp/pluginbuilder_eclipse/eclipse/configuration" includes="*.log"/>
        </copy>
    </target>
    <target name="-delete.eclipse.configuration.log">
    	<delete failonerror="false" verbose="false" quiet="true">
    		<fileset dir="${basedir}/pluginbuilder_tmp/pluginbuilder_eclipse/eclipse/configuration" includes="*.log"/>
    	</delete>
    </target>
    <target name="-copy.pluginbuilder.compile.error" unless="is.thisbuildsuccessful">
        <copy todir="${ccProjectDir}/${cctimestamp}" failonerror="false" verbose="false">
            <fileset dir="${buildDirectory}/plugins" includes="**/*dot.bin.log"/>
        </copy>
    </target>
    <target name="-copy.javaoutput" > 
    	<!-- maybe use 'unless="is.thisbuildsuccessful"' to no copy javaoutput.txt on successful builds -->
        <copy file="${buildDirectory}/javaoutput.txt" 
                     todir="${ccProjectDir}/${cctimestamp}"
                     failonerror="false" verbose="true"/>
    </target>
    <target name="-disable.automated.test" if="isIgnoreTests">
    	<replace file="${pluginbuilder.config}" token="pluginbuilder.is.runtests=true" value="pluginbuilder.is.runtests=false"/>
    </target>
    <target name="-enable.automated.test" unless="isIgnoreTests">
    	<replace file="${pluginbuilder.config}" token="pluginbuilder.is.runtests=false" value="pluginbuilder.is.runtests=true"/>
    </target>
    
    <target name="-fail.if.file.exists" unless="isSkipPublish">
        <fail message="Release zip already exists: ${file} (delete or use -Doverwrite=true)">
              <condition>
                 <and>
                     <available file="${file}"/>
                     <not><equals arg1="${overwrite}" arg2="true"/></not>
                 </and>
              </condition>
          </fail>
    </target>
              	
    <target name="-merge.updatesite.xml" unless="isSkipPublish">
        <xslt in="${projectsRootDir}/org.faktorips.updatesite/${siteXmlFileName}" out="${projectsRootDir}/org.faktorips.updatesite/site_merge.xml" 
        	style="${projectsRootDir}/org.faktorips.build/cruisecontrol_config/xsl/mergeupdatesite.xsl" force="true">
            <outputproperty name="method" value="xml"/>
            <outputproperty name="encoding" value="UTF-8"/>
            <outputproperty name="indent" value="yes"/>
            <param name="doc2" expression="${projectsRootDir}/org.faktorips.updatesite/${site.xml}"/>
        </xslt>
        <delete file="${projectsRootDir}/org.faktorips.updatesite/${site.xml}" verbose="false"/>
        <copy file="${projectsRootDir}/org.faktorips.updatesite/site_merge.xml" tofile="${projectsRootDir}/org.faktorips.updatesite/${siteXmlFileName}" verbose="false" overwrite="true"/>
        <delete file="${projectsRootDir}/org.faktorips.updatesite/site_merge.xml" verbose="false"/>
    </target>

</project>
