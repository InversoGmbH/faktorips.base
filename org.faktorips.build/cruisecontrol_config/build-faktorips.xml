<?xml version="1.0" encoding="UTF-8"?>
<!--============================================================================================-->
<!--Delegating build script, used by cruisecontrol to build MY_PROJECT_1.-->
<!--Note that the basedir is set to the checked out project-->
<!--============================================================================================-->
<project name="build-faktorips" basedir="checkout/../">
    <!-- global properties -->
	<property name="cvsroot" value=":local:/usr/local/cvsroot"/>
    
	<!--needs to be updated on every buildcall IMPORTANT - DONT TOUCH THIS!!!!-->
    <target name="updateBuildTemplate">
        <property name="cvsBuildmodule" value="org.faktorips.build"/>
        <property name="projectBuildDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsBuildmodule}" dest="${projectBuildDir}" cvsroot="${cvsroot}" quiet="true"/>
    </target>
    
	<!--============================================================================================-->
    <!--project targets. please note: each new target has to be a dependant of "updateBuildTemplate"-->
    <!--============================================================================================-->
	
    <target name="util" depends="updateBuildTemplate" description="builds the 'org.faktorips.util' project">
        <property name="cvsUtilmodule" value="org.faktorips.util"/>
        <property name="projectUtilDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsUtilmodule}" dest="${projectUtilDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectUtilDir}/${cvsUtilmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectUtilDir}/${cvsUtilmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="valuetypes" depends="updateBuildTemplate" description="builds the 'org.faktorips.valuetypes' project">
        <property name="cvsValuetypesmodule" value="org.faktorips.valuetypes"/>
        <property name="projectValuetypesDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsValuetypesmodule}" dest="${projectValuetypesDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectValuetypesDir}/${cvsValuetypesmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectValuetypesDir}/${cvsValuetypesmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="valuetypes.java5" depends="updateBuildTemplate" description="builds the 'org.faktorips.valuetypes.java5' project">
        <property name="cvsValuetypesmodule" value="org.faktorips.valuetypes.java5"/>
        <property name="projectValuetypesDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsValuetypesmodule}" dest="${projectValuetypesDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectValuetypesDir}/${cvsValuetypesmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectValuetypesDir}/${cvsValuetypesmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="dtflcommon" depends="updateBuildTemplate" description="builds the 'org.faktorips.dtflcommon' project">
        <property name="cvsDtflcommonmodule" value="org.faktorips.dtflcommon"/>
        <property name="projectDtflcommonDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsDtflcommonmodule}" dest="${projectDtflcommonDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectDtflcommonDir}/${cvsDtflcommonmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectDtflcommonDir}/${cvsDtflcommonmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="runtime" depends="updateBuildTemplate" description="builds the 'org.faktorips.runtime' project">
        <property name="cvsRuntimemodule" value="org.faktorips.runtime"/>
        <property name="projectRuntimeDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsRuntimemodule}" dest="${projectRuntimeDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the clean-target-->
        <ant dir="${projectRuntimeDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="clean"/>
        <!--Call the target that does everything-->
        <ant dir="${projectRuntimeDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="runtime.java5" depends="updateBuildTemplate" description="builds the 'org.faktorips.runtime.java5' project">
        <property name="cvsRuntimemodule" value="org.faktorips.runtime.java5"/>
        <property name="projectRuntimeDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsRuntimemodule}" dest="${projectRuntimeDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the clean-target-->
        <ant dir="${projectRuntimeDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="clean"/>
        <!--Call the target that does everything-->
        <ant dir="${projectRuntimeDir}/${cvsRuntimemodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="fl" depends="updateBuildTemplate" description="builds the 'org.faktorips.fl' project">
        <property name="cvsFlmodule" value="org.faktorips.fl"/>
        <property name="projectFlDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsFlmodule}" dest="${projectFlDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="cleanParserSource"/>
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
    <target name="devtools.ant" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.ant' project">
        <property name="cvsAntModule" value="org.faktorips.devtools.ant"/>
        <property name="projectAntDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsAntModule}" dest="${projectAntDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectAntDir}/${cvsAntModule}/" antfile="scripts/buildExtraJAR.xml" target="clean"/>
        <ant dir="${projectAntDir}/${cvsAntModule}/" antfile="scripts/buildExtraJAR.xml" target="main"/>
    </target>
	
    <target name="devtools.core" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.core' project">
        <property name="cvsFlmodule" value="org.faktorips.devtools.core"/>
        <property name="projectFlDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsFlmodule}" dest="${projectFlDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="devtools.core.ui" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.core.ui' project">
        <property name="cvsCoreUimodule" value="org.faktorips.devtools.core.ui"/>
        <property name="projectCoreUiDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsCoreUimodule}" dest="${projectCoreUiDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectCoreUiDir}/${cvsCoreUimodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectCoreUiDir}/${cvsCoreUimodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="devtools.stdbuilder" depends="updateBuildTemplate" description="builds the 'org.faktorips.devtools.stdbuilder' project">
        <property name="cvsFlmodule" value="org.faktorips.devtools.stdbuilder"/>
        <property name="projectFlDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsFlmodule}" dest="${projectFlDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
	
    <!--============================================================================================-->
    <!--project targets for additional customers plugins, e.g. BBV, KQV-->
    <!--============================================================================================-->
    
	<target name="de.bbv.faktorips.runtime" depends="updateBuildTemplate" description="builds the 'de.bbv.faktorips.runtime' project">
        <property name="cvsFlmodule" value="de.bbv.faktorips.runtime"/>
        <property name="projectFlDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co de.bbv.cm.CMPlugin" dest="${projectFlDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co ${cvsFlmodule}" dest="${projectFlDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
		
    <target name="de.bbv.faktorips.devtools" depends="updateBuildTemplate" description="builds the 'de.bbv.faktorips.devtools' project">
        <property name="cvsFlmodule" value="de.bbv.faktorips.devtools"/>
        <property name="projectFlDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co de.bbv.cm.CMPlugin" dest="${projectFlDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co ${cvsFlmodule}" dest="${projectFlDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="de.qv.faktorips" depends="updateBuildTemplate" description="builds the 'de.qv.faktorips' project">
        <property name="cvsFlmodule" value="de.qv.faktorips"/>
        <property name="projectFlDir" value="checkout/"/>
        <!--checkout/update project-->
        <cvs command="co ${cvsFlmodule}" dest="${projectFlDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
    <target name="devtools.msgpm" depends="updateBuildTemplate" description="builds the  project">
        <property name="cvsFlmodule" value="org.faktorips.devtools.msgpm"/>
        <property name="projectFlDir" value="checkout/"/>
        <!--checkout/update project-->
        <delete includeemptydirs="true" dir="${cvsFlmodule}"/>
        <cvs command="co ${cvsFlmodule}" dest="${projectFlDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--Call the target that does everything-->
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="clean"/>
        <ant dir="${projectFlDir}/${cvsFlmodule}/build/" antfile="build.xml" target="buildjar"/>
    </target>
	
	
    <!--============================================================================================-->
    <!--targets using the pluginbuilder,-->
    <!--build and test the faktorips feature and runs the integration test-->
    <!--============================================================================================-->
    
	<!--this target build the faktorips features and runs the plugin tests-->
    <target name="pluginbuilder.faktorips" description="builds the complete faktorips feature and executes all junit plugin test">
        <property name="cvsPluginbuildermodule" value="org.faktorips.pluginbuilder"/>
        <property name="projectPluginbuilderDir" value="checkout/"/>
    	<!--checkout org.faktorips.pluginbuilder project-->
        <cvs command="co ${cvsPluginbuildermodule}" dest="${projectPluginbuilderDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co org.faktorips.feature" dest="${projectPluginbuilderDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co org.faktorips.feature.nls1" dest="${projectPluginbuilderDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co org.faktorips.nls.devtools.core.nl1" dest="${projectPluginbuilderDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co org.faktorips.feature.test" dest="${projectPluginbuilderDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co org.faktorips.devtools.core.test" dest="${projectPluginbuilderDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co org.faktorips.devtools.core.ui.test" dest="${projectPluginbuilderDir}" cvsroot="${cvsroot}" quiet="true"/>
        <cvs command="co org.faktorips.devtools.stdbuilder.test" dest="${projectPluginbuilderDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!-- delegate to the pluginbuilder target -->
    	<ant dir="${projectPluginbuilderDir}/org.faktorips.pluginbuilder/" antfile="build.xml" target="main-cc">
            <property name="label" value="HEAD"/>
        </ant>
    </target>
	<!-- target to copy cc build artefacts -->
	<target name="copy.artifacts.pluginbuilder.faktorips" description="target to copy cc build artefacts">
		<!-- properties from cc: ccProjectDir (defined in config.xml), cctimestamp (see cc reference)-->
		
		<!-- copy eclipse workspace logfile -->
		<mkdir dir="${ccProjectDir}/${cctimestamp}"/>
		<copy file="${basedir}/pluginbuilder_tmp/org.faktorips.pluginbuilder/workspace/.metadata/.log" 
			tofile="${ccProjectDir}/${cctimestamp}/eclipse_workspace.log"
		    failonerror="false" verbose="true"/>
		
		<!-- copy autoamted test html report -->
		<copy file="${basedir}/pluginbuilder_tmp/org.faktorips.pluginbuilder/results/testresults/html/testReport_N-${label}.html" 
			todir="${ccProjectDir}/${cctimestamp}"
			failonerror="false" verbose="true"/>
	</target>
	
    <!--this target runs the integrationtest, 
       the target org.faktorips.pluginbuilder must be executed before, this will be handled by cruisecontrol-->
    <target name="pluginbuilder.integrationtest" description="target to run the faktorips integrationtest, using the previous build faktorips feature">
        <property name="projectPluginbuilderDir" value="checkout/"/>
        <property name="cvsIntegrationtestmodule" value="org.faktorips.integrationtest"/>
        <property name="projectIntegrationtestDir" value="checkout/"/>
        <!--checkout org.faktorips.integrationtest project-->
        <cvs command="co ${cvsIntegrationtestmodule}" dest="${projectIntegrationtestDir}" cvsroot="${cvsroot}" quiet="true"/>
        <!--delegate to the pluginbuilder integrationtest target-->
        <ant dir="${projectPluginbuilderDir}/org.faktorips.pluginbuilder/" antfile="build.xml" target="integrationtest"/>
    </target>
	
    <!--this target builds the faktorips release madatory parameter: 
           -Dbuild.version -> the version which will be released -->
    <!--note that if this script is running local without cvs the following parameter must be set:
        optional parameters:
           -DuseCvs=false -> no cvs support 
           -Dall.map=all_copy.map -> copy features and plugins from the workspace instead of using a releas tag with cvs 
           -DprojectPluginbuilderDir -> the root dir of all plugin projects
           -DbaseDir -> the parent dir of the dir specified in projectPluginbuilderDir
         additionaly make sure that the build_host_<hostname>.properies exists in the pluginbuilder project-->
    <target name="release.faktorips" description="release build for an specified faktorips release version, builds the complete feature,                  executes the junit plugin tests and distributes the result to the update site and download directory">
        <property name="useCvs" value="true"/>
        <property name="projectPluginbuilderDir" value="checkout/"/>
        <property name="downloadDir" value="/var/www/localhost/htdocs/update.faktorzehn.org/faktorips/downloads"/>
        <property name="buildDirectory" value="${basedir}/pluginbuilder_release_tmp/org.faktorips.pluginbuilder_release"/>
        
    	<condition property="isUseCvs" value="true">
            <equals arg1="${useCvs}" arg2="true"/>
        </condition>
    	
        <!-- TODO create plugin builder property file using build.version 
             cvs tag depending on the build.version -->
    	
    	<!--asserts-->
        <!--1. check if the build.version property is given-->
        <fail unless="build.version" message="Please specify the build.version, e.g. ant ... -Dbuild.version=2.2.0.rfinal"/>
    	<!--2. check if the build.verion property file exists-->
        <available type="file" file="${projectPluginbuilderDir}/org.faktorips.pluginbuilder/releases/${build.version}.properties" property="releasePropertiesExists"/>
        <fail message="Could not find ${build.version}.properties in ${projectPluginbuilderDir}/org.faktorips.pluginbuilder/releases/" unless="releasePropertiesExists"/>
    	
    	<!-- TODO checkout org.faktorips.pluginbulder using build.version in pluginbuilder_release_tmp -->

        <!--checkout updatesite-->
    	<antcall inheritall="true" target="-checkout.updatesite"/>
        <!--build release unsing pluginbuilder main target-->
        <ant dir="${projectPluginbuilderDir}/org.faktorips.pluginbuilder/" antfile="build.xml" target="main">
            <property name="build.version" value="${build.version}"/>
            <property name="buildDirectory" value="${buildDirectory}"/>
        </ant>
        <!--copy zipped features into the faktorips download directory, fails if files already exists-->
        <!--TODO add overwite switch as property, assert if exists above-->
    	
    	<fail message="release already exists">
    	    <condition>
    	       	<available file="${downloadDir}/faktorips_${build.version}.zip"/>
    	     </condition>
    	</fail>
    	
    	<copy file="${buildDirectory}/results/org.faktorips.feature-${build.version}.zip" 
    		tofile="${downloadDir}/faktorips_${build.version}.zip" overwrite="false" verbose="true" failonerror="true"/>
        <copy file="${buildDirectory}/results/org.faktorips.feature.nls1-${build.version}.zip" 
        	tofile="${downloadDir}/faktorips.nls1_${build.version}.zip" overwrite="false" verbose="true" failonerror="true"/>
        <!--install the features on updatesite-->
        <!--1. generate a new site.xml on the updatesite, including all previous and new feature versions-->
        <ant dir="${projectPluginbuilderDir}/org.faktorips.pluginbuilder/build-files" antfile="postBuild.xml" target="-createNightlyBuildSiteXml">
            <property name="siteXmlFile" value="${basedir}/${projectPluginbuilderDir}/org.faktorips.updatesite/site_tmp.xml"/>
            <property name="pluginbuilder.features" value="org.faktorips.feature,org.faktorips.feature.nls1"/>
            <property name="buildDirectory" value="${buildDirectory}"/>
            <property name="buildHome" value="${basedir}/${projectPluginbuilderDir}/org.faktorips.pluginbuilder"/>
            <property name="updateSiteCategoryName" value="Faktor-IPS ${build.version}"/>
            <property name="updateSiteCategoryLabel" value="Faktor-IPS ${build.version}"/>
            <property name="updateSiteDescription" value="FaktorIPS update site"/>
            <property name="updateSiteUrl" value="http://update.faktorzehn.org/faktorips"/>
        </ant>
        <!--2. copy all features and plugins to the updatesite-->
        <copy todir="${projectPluginbuilderDir}/org.faktorips.updatesite/plugins" overwrite="false">
            <fileset dir="${buildDirectory}/updateSite/plugins" includes="*.jar" verbose="true"/>
        </copy>
        <copy todir="${projectPluginbuilderDir}/org.faktorips.updatesite/features" overwrite="false">
            <fileset dir="${buildDirectory}/updateSite/features" includes="*.jar" verbose="true"/>
        </copy>
    	
        <!--3. merge the generated site.xml with the previous site.xml as new site.xml-->
        <antcall inheritall="true" target="-merge.updatesite.xml"/>
        
    	<!--checkin updatesite-->
        <antcall inheritall="true" target="-checkin.updatesite"/>
    	
    	<!--4. checkout on faktorips updatesite website directory -->
    	<antcall inheritall="true" target="-checkout.updatesite.on.faktorips.org"/>
    	
    </target>
	
    <!--helper targets-->
    <target name="-checkout.updatesite" if="isUseCvs">
        <cvs command="co org.faktorips.updatesite" dest="checkout/" cvsroot="${cvsroot}" quiet="true"/>
    </target>
    <target name="-checkin.updatesite" if="isUseCvs">
        <cvs command="commit -m 'release build: ${build.version}'" 
        	package="org.faktorips.updatesite" dest="checkout/" cvsroot="${cvsroot}" quiet="true"/>
    </target>
    <target name="-checkout.updatesite.on.faktorips.org" if="isUseCvs">
    	<property name="faktorips.org.updatesite.dir" value="/var/www/localhost/htdocs/update.faktorzehn.org/faktorips/" />
    	<cvs command="co org.faktorips.updatesite" dest="${faktorips.org.updatesite.dir}" cvsroot="${cvsroot}" quiet="true"/>
    </target>

    <target name="-merge.updatesite.xml">
        <xslt in="${projectPluginbuilderDir}/org.faktorips.updatesite/site.xml" out="${projectPluginbuilderDir}/org.faktorips.updatesite/site_merge.xml" style="${projectPluginbuilderDir}/org.faktorips.build/cruisecontrol_config/xsl/mergeupdatesite.xsl" force="true">
            <outputproperty name="method" value="xml"/>
            <outputproperty name="encoding" value="UTF-8"/>
            <outputproperty name="indent" value="yes"/>
            <param name="doc2" expression="${basedir}/${projectPluginbuilderDir}/org.faktorips.updatesite/site_tmp.xml"/>
        </xslt>
        <delete file="${projectPluginbuilderDir}/org.faktorips.updatesite/site_tmp.xml" verbose="false"/>
        <copy file="${projectPluginbuilderDir}/org.faktorips.updatesite/site_merge.xml" tofile="${projectPluginbuilderDir}/org.faktorips.updatesite/site.xml" verbose="false" overwrite="true"/>
        <delete file="${projectPluginbuilderDir}/org.faktorips.updatesite/site_merge.xml" verbose="false"/>
    </target>
</project>